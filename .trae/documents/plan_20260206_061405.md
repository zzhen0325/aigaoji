# 修复折线图仅显示单点及历史数据缺失问题

## 核心问题分析
1. **请求冲突与竞态条件**：`loadPortfolioIntraday` 每 5 秒触发一次并增加 `requestId`。由于分时回填（Backfill）涉及多个 API 调用，耗时通常超过 5 秒，导致后续请求增加 `requestId` 后，先前的回填工作在完成时因 ID 不匹配而被丢弃，使得图表始终停留在初始的“单点/保底”状态。
2. **合并逻辑缺陷**：`mergeIntradayPoints` 在合并新旧数据时，若旧数据已存在该时间点，则不更新。这导致在回填过程中，初始的零值或错误值无法被后续加载的真实数据覆盖。
3. **数据贡献不一致**：在回填过程中，尚未加载完成的基金对历史点的贡献被计为 0，导致图表曲线在加载过程中会出现巨大的数值波动（跳变）。

## 实施计划

### 1. 优化调度逻辑
- 引入 `intradayBackfillInProgress` Ref，防止多个回填任务同时运行。
- 修改 `loadPortfolioIntraday`：
  - 如果回填正在进行，仅更新“当前”时间点的最新估值，不重启回填工人（Workers）。
  - 如果回填未运行，则启动回填流程。
- 将分时数据的刷新频率从 5 秒放宽至 15 秒（估值刷新仍保持 5 秒），为数据抓取留出充足时间。

### 2. 改进数据合并策略
- 修改 `mergeIntradayPoints`，允许 `next` 数据覆盖 `prev` 数据中的同名时间点，确保回填数据能正确更新。
- 优化 `INTRADAY_BACKFILL_CONCURRENCY` 从 2 提升至 5，加快首次加载速度。

### 3. 增强数据稳定性
- 优化 `buildPortfolioIntradayData`：
  - 在计算历史点位时，对于尚未加载完成的基金，使用其当前估值反推或合理的默认值，减少加载过程中的曲线跳变。
  - 确保即使在只有一个数据点时，也能通过插值显示一条合理的线段而非单点。

### 4. 验证与测试
- 观察页面加载后，分时图表是否能从“单线”逐渐平滑地回填为完整的历史曲线。
- 检查 Tooltip 在移动过程中是否能显示全天各时段的数据。
- 确认在市场交易时段，图表末端能随实时估值动态更新。

## 关键代码修改点
- [Portfolio.tsx](file:///Users/bytedance/Desktop/seeseezz/jijin/src/pages/portfolio/Portfolio.tsx) 中的 `mergeIntradayPoints` 函数。
- [Portfolio.tsx](file:///Users/bytedance/Desktop/seeseezz/jijin/src/pages/portfolio/Portfolio.tsx) 中的 `loadPortfolioIntraday` 及其内部的 `workers` 逻辑。
- [Portfolio.tsx](file:///Users/bytedance/Desktop/seeseezz/jijin/src/pages/portfolio/Portfolio.tsx) 中的 `useEffect` 调度部分。
